# Анализ текущей бизнес-логики и структуры приложения

Этот документ описывает текущее состояние системы, восстановленное на основе анализа кода (базы данных, API и сервисов). 
**Цель:** Свериться с вами, правильно ли реализованы процессы, и выявить расхождения с реальностью.

---

## 1. Основные сущности (Что мы учитываем)

Система построена вокруг учета затрат на строительные объекты.

*   **Объекты (CostObject)**: Стройки. Имеют бюджет, сроки, статус.
*   **Пользователи (User)**: Сотрудники с ролями.
*   **Бригады (Brigade)**: Группы рабочих под управлением прораба.
*   **Табели (TimeSheet)**: Учет времени работы бригад (РТБ).
*   **Заявки на материалы (MaterialRequest)**: Потребность в материалах от прорабов.
*   **УПД (MaterialCost)**: Фактические затраты (накладные от поставщиков).
*   **Заявки на технику (EquipmentOrder)**: Аренда спецтехники.

---

## 2. Роли и Доступы (Кто что делает)

В системе реализованы следующие роли:

1.  **FOREMAN (Прораб)**:
    *   Создает заявки на материалы.
    *   Управляет бригадами и табелями.
    *   Запрашивает доступ к объектам.
    *   Видит только свои объекты и заявки.
2.  **MATERIALS_MANAGER (Снабженец / Менеджер по материалам)**:
    *   Обрабатывает заявки на материалы (заказывает их).
    *   Загружает и распределяет УПД.
    *   Видит все заявки и склады.
3.  **PROCUREMENT_MANAGER (Руководитель снабжения?)**:
    *   Согласовывает (одобряет) или отклоняет заявки на материалы.
4.  **ACCOUNTANT (Бухгалтер)**:
    *   Загружает УПД.
    *   Следит за дубликатами.
    *   Видит финансовые отчеты.
5.  **MANAGER (Руководитель проекта)**:
    *   Полный просмотр, управление объектами.

---

## 3. Бизнес-процессы (Как это работает)

### А. Жизненный цикл Заявки на материалы (Material Request)
Процесс, по которому прораб получает материалы на объект.

1.  **Создание (NEW)**
    *   **Кто:** Прораб.
    *   **Действие:** Создает заявку, указывает материалы, количество и срочность (Обычная/Срочная/Критическая).
2.  **Согласование (APPROVED / REJECTED)**
    *   **Кто:** Procurement Manager.
    *   **Действие:** Проверяет заявку. Если ок -> "Approved". Если нет -> "Rejected" с причиной.
3.  **В обработке (IN_PROCESSING)**
    *   **Кто:** Materials Manager.
    *   **Действие:** Берет согласованную заявку в работу, указывает ожидаемую дату поставки.
4.  **Заказ (ORDERED)**
    *   **Кто:** Materials Manager.
    *   **Действие:** Находит поставщика, заказывает товар. Вносит данные поставщика и номер заказа.
5.  **Доставка (PARTIALLY_DELIVERED / SHIPPED)**
    *   **Кто:** Materials Manager.
    *   **Действие:** Отмечает факт отгрузки или частичной доставки.
6.  **Завершение (COMPLETED)**
    *   **Кто:** Materials Manager.
    *   **Действие:** Заявка выполнена. (Система требует полного распределения позиций для закрытия).

### Б. Обработка УПД (Фактические затраты)
Процесс, так как мы фиксируем расходы.

1.  **Загрузка**
    *   **Кто:** Бухгалтер или Снабженец.
    *   **Вход:** XML файл (форматы 1С, Диадок, Elewise и др.).
    *   **Действие:** Система парсит файл, создает черновик УПД. Проверяет на дубликаты.
2.  **Распределение (Distribution)**
    *   **Кто:** Снабженец.
    *   **Суть:** В УПД может быть 10 тонн цемента. Снабженец должен сказать: "5 тонн пошло на Объект А (по заявке №1), а 5 тонн на Объект Б".
    *   **Связь:** Позиции УПД связываются с **Заявками на материалы** или просто списываются на **Объект**.
3.  **Статус:**
    *   УПД переходит в статус `DISTRIBUTED` когда всё распределено.

### В. Регистрация и Вход
1.  **Telegram:** Пользователь может зарегистрироваться через Telegram бота.
2.  **Web:** Вход по логину/паролю. Роли "вшиты" в токен.

---

## 4. Вопросы для анализа (Что мне показалось странным)

В ходе анализа кода возникли вопросы, которые могут указывать на "дыры" в логике:

1.  **Связь Заявка <-> УПД**: Сейчас распределение УПД *может* ссылаться на заявку, но это не жестко. Можно распределить УПД просто на объект. Правильно ли это?
2.  **Приемка материалов на объекте**: Я не вижу этапа, где **Прораб** подтверждает: "Да, я реально получил эти материалы по УПД". Сейчас цепочка заканчивается на менеджере, который говорит "Отгружено/Распределено".
    *   *Риск:* Менеджер может списать материалы, а прораб их не увидит.
3.  **Автоматизация статусов**: Заявка переходит в `COMPLETED` вручную менеджером или автоматически при полном распределении УПД? В коде есть ручка `/complete`, но логика проверки распределения мягкая.

---

**Пожалуйста, проанализируйте этот отчет и скажите:**
1.  Где описание процесса не совпадает с тем, как вы работаете?
2.  Какие из "странностей" (п.4) для вас критичны?
