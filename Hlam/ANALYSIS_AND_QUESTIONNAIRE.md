# Детальный анализ проекта "Система учета затрат"

## 1. Обзор архитектуры и структуры проекта

Проект представляет собой современное web-приложение для учета затрат в строительстве, построенное по классической схеме "Клиент-Сервер".

### Технологический стек
*   **Backend**: Python (FastAPI) — обеспечивает логику, API и работу с данными.
*   **Database**:
    *   *Текущее состояние*: SQLite (`construction_costs.db` / `app.db`) — используется по умолчанию в конфигурации.
    *   *Целевое состояние*: PostgreSQL 15 + Redis 7 — описано в `docker-compose.yml` и плане разработки как критическая задача.
*   **Frontend**: React + TypeScript + Vite — пользовательский интерфейс.
*   **Telegram Bot**: aiogram 3.x — для оперативных уведомлений и простых действий.
*   **Хранилище**: MinIO (S3-compatible) — для хранения XML файлов УПД.

### Структура проекта
Проект имеет четкую модульную структуру:
*   `backend/app/` — Ядро системы.
    *   `auth/` — Модуль авторизации (JWT, роли).
    *   `objects/` — Управление строительными объектами.
    *   `time_sheets/` — Табели рабочего времени (РТБ).
    *   `materials/`, `equipment/` — Заявки на ресурсы.
    *   `upd/` — Сложный модуль парсинга XML файлов УПД.
    *   `bot/` — Логика Telegram-бота.
*   `frontend/src/` — Исходный код интерфейса.
*   `docs/` — Обширная документация, разбитая по категориям.
*   `scripts/` — Утилиты для обслуживания (бэкапы, проверки).

---

## 2. Анализ логических цепочек (примеры)

В системе реализованы сложные бизнес-процессы. Вот несколько ключевых примеров того, как данные проходят через систему:

### Пример А: Жизненный цикл "Заявка на материалы"
1.  **Инициация**: Прораб (Foreman) создает заявку через Telegram-бот или Web-интерфейс (статус `NEW`).
2.  **Обработка**: Заявка попадает Менеджеру по закупкам.
3.  **Закупка**: Менеджер оформляет заказ поставщику.
4.  **Подтверждение**: Бухгалтер получает УПД (XML) от поставщика и загружает его в систему.
5.  **Распределение (Matching)**: Система парсит УПД и предлагает "привязать" товары из УПД к строкам заявки Прораба.
6.  **Закрытие**: Когда все позиции заявки покрыты УПД, заявка переходит в статус `COMPLETED`.

### Пример Б: Контроль бюджета (Логика уведомлений)
1.  **Действие**: Происходит добавление расхода (например, утверждение табеля или распределение УПД) на `Объект А`.
2.  **Проверка**: Система пересчитывает поле `budget_spent` для `CostObject`.
3.  **Условие**: Если `budget_spent` / `budget_amount` > 0.8 (80%) И уведомление еще не отправлялось (`budget_alert_80_sent == False`).
4.  **Реакция**:
    *   Отправляется сообщение в Telegram руководителю.
    *   В базе данных ставится флаг `budget_alert_80_sent = True`, чтобы не спамить.

---

## 3. Анализ документации

Документация проекта находится на **очень высоком уровне**.
*   `START_HERE.md` — Идеальная точка входа, навигация понятна.
*   `План_разработки.md` — Детальный Roadmap с приоритетами.
*   `docs/` — Хорошая категоризация.

**Однако, есть расхождения между документацией и кодом:**
*   В Плане задача "Миграция на PostgreSQL" помечена как критическая и необходимая, но в `backend/app/core/config.py` по умолчанию все еще стоит `sqlite`.
*   В Плане указано, что роль `MANAGER` и `AuditLog` выполнены (зеленые галочки), что подтверждается кодом (`models.py` содержит эти сущности).

---

## 4. Найденные потенциальные проблемы и несоответствия

В ходе анализа кода и структур были выявлены следующие моменты:

1.  **Конфигурация Базы Данных**:
    *   В `backend/app/core/config.py` указано: `database_url: str = "sqlite+aiosqlite:///./construction_costs.db"`.
    *   В `backend/docker-compose.yml` настроен PostgreSQL.
    *   **Риск**: При запуске через `docker-compose` (если раскомментировать API) контейнер может пытаться стучаться в Postgres, а локальный запуск (`python main.py`) будет использовать SQLite. Возможна путаница с данными ("Я создал пользователя, а его нет").

2.  **Рассинхрон Frontend и Backend**:
    *   В Backend (`models.py`) в таблицу `CostObject` добавлены поля для бюджета: `budget_amount`, `budget_alert_80_sent`.
    *   В Frontend (`frontend/src/types/index.ts`) в интерфейсе `CostObject` эти поля **отсутствуют**.
    *   **Риск**: Фронтенд не сможет отобразить бюджеты и прогресс-бары, хотя бэкенд это поддерживает.

3.  **Docker Compose**:
    *   В `backend/docker-compose.yml` сервис `api` закомментирован. Это значит, что сейчас Docker поднимает только инфраструктуру (БД, Redis, MinIO), а само приложение нужно запускать вручную. Это не соответствует принципу "Запуск одной командой".

---

# Опросник по проекту (QUESTIONNAIRE)

Ниже приведен список вопросов и уточнений, которые возникли в ходе анализа. Пожалуйста, ответьте на них для планирования дальнейших действий.

### Блок 1: Инфраструктура и База Данных
1.  **PostgreSQL vs SQLite**: Сейчас проект настроен на SQLite (`config.py`), хотя инфраструктура для Postgres готова.
    *   *Вопрос*: Хотите ли вы, чтобы я переключил конфигурацию на PostgreSQL прямо сейчас и убедился, что приложение работает с ним? (Это потребует настройки миграций).
2.  **Файлы БД**: Я вижу файлы `construction_costs.db` и `app.db`. Какой из них является актуальным источником данных на данный момент?
3.  **Docker**: Стоит ли раскомментировать сервис `api` в `docker-compose.yml`, чтобы приложение полностью запускалось в контейнерах?

### Блок 2: Функционал
4.  **Бюджетирование**: На бэкенде поля для бюджета есть, но на фронтенде типов под них нет.
    *   *Вопрос*: Нужно ли мне обновить типы на фронтенде и добавить отображение бюджета (прогресс-бар) в карточку объекта?
5.  **Уведомления**: Прописаны ли у пользователей реальные `telegram_chat_id`? Без этого функции уведомлений (о бюджете, заявках) тестировать будет сложно.

### Блок 3: Дальнейшие шаги
6.  С чего вы хотите начать работу со мной?
    *   А) Исправление инфраструктуры (переход на Postgres).
    *   Б) Доработка фронтенда (отображение бюджетов).
    *   В) Исправление ошибок в документации/типах.
    *   Г) Реализация новой функции из Плана.
