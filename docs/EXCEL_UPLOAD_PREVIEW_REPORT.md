# –û—Ç—á—ë—Ç: Excel –∑–∞–≥—Ä—É–∑–∫–∞ —Å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º

**–î–∞—Ç–∞:** 26 —è–Ω–≤–∞—Ä—è 2026 –≥.  
**–ú–æ–¥—É–ª—å:** –¢–∞–±–µ–ª–∏ –†–¢–ë ‚Äî Excel –∑–∞–≥—Ä—É–∑–∫–∞ —Å preview –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π

---

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. ExcelPreviewService

**–§–∞–π–ª:** `backend/app/time_sheets/excel_preview_service.py`

**–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ü–∞—Ä—Å–∏–Ω–≥ Excel —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–º—è—Ç—å
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
- –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ preview (in-memory, –≥–æ—Ç–æ–≤–æ –¥–ª—è Redis)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å—Ç–µ—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 1 —á–∞—Å
- –û–±–æ–≥–∞—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ –æ–±—ä–µ–∫—Ç–æ–≤)

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**

#### create_preview()
–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑ Excel —Ñ–∞–π–ª–∞

**–õ–æ–≥–∏–∫–∞:**
1. –ü–∞—Ä—Å–∏–Ω–≥ Excel —á–µ—Ä–µ–∑ TimeSheetExcelParser
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –±—Ä–∏–≥–∞–¥—ã
3. –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏:
   - –ü–æ–∏—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤ –±—Ä–∏–≥–∞–¥–µ –ø–æ –§–ò–û
   - –ü–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–∞ —É—á—ë—Ç–∞ –≤ –ë–î
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–∞—Å–æ–≤ (0-24, >12 = warning)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç—ã
4. –ü–æ–¥—Å—á—ë—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç—å —Å TTL 1 —á–∞—Å
6. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ preview_id

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```python
{
  "preview_id": "uuid",
  "brigade_id": 1,
  "brigade_name": "–ë—Ä–∏–≥–∞–¥–∞ ‚Ññ1",
  "period_start": "2026-01-15",
  "period_end": "2026-01-21",
  "items": [...],  # –í—Å–µ —Å—Ç—Ä–æ–∫–∏ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
  "stats": {...},  # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  "expires_at": timestamp
}
```

---

#### _validate_and_enrich()
–í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ–±–æ–≥–∞—â–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫

**–î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
1. **–°–æ—Ç—Ä—É–¥–Ω–∏–∫:**
   - –ü–æ–∏—Å–∫ –ø–æ –§–ò–û –≤ —á–ª–µ–Ω–∞—Ö –±—Ä–∏–≥–∞–¥—ã (case-insensitive)
   - –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç member_id
   - –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –æ—à–∏–±–∫–∞ "–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±—Ä–∏–≥–∞–¥–µ"

2. **–û–±—ä–µ–∫—Ç —É—á—ë—Ç–∞:**
   - –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞—Ö (case-insensitive)
   - –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç cost_object_id
   - –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –æ—à–∏–±–∫–∞ "–û–±—ä–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"

3. **–ß–∞—Å—ã:**
   - ‚â§ 0 ‚Üí –æ—à–∏–±–∫–∞
   - > 24 ‚Üí –æ—à–∏–±–∫–∞
   - > 12 ‚Üí –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞)

4. **–î–∞—Ç–∞:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ ISO
   - –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è ‚Üí –æ—à–∏–±–∫–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏:**
```python
{
  "row_number": 5,
  "member_name": "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω",
  "member_id": 10,
  "member_verified": True,
  "date": "2026-01-15",
  "cost_object_name": "–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –¥–æ–º–∞",
  "cost_object_id": 3,
  "cost_object_verified": True,
  "hours": 14.0,
  "valid": True,
  "errors": [],
  "warnings": ["–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞: 14 —á–∞—Å–æ–≤ (>12)"]
}
```

---

#### _calculate_stats()
–ü–æ–¥—Å—á—ë—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –¥–∞–Ω–Ω—ã–º

**–ú–µ—Ç—Ä–∏–∫–∏:**
- `total_rows` ‚Äî –≤—Å–µ–≥–æ —Å—Ç—Ä–æ–∫
- `valid_rows` ‚Äî –≤–∞–ª–∏–¥–Ω—ã—Ö —Å—Ç—Ä–æ–∫
- `invalid_rows` ‚Äî —Å—Ç—Ä–æ–∫ —Å –æ—à–∏–±–∫–∞–º–∏
- `total_hours` ‚Äî —Å—É–º–º–∞ —á–∞—Å–æ–≤ (—Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ)
- `overtime_cases` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–æ–∫ >12—á
- `unique_members` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
- `unique_objects` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
- `has_errors` ‚Äî –µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∏
- `has_warnings` ‚Äî –µ—Å—Ç—å –ª–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

---

### 2. –ù–æ–≤—ã–µ API Endpoints

#### POST /api/v1/time-sheets-excel/upload-preview

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ó–∞–≥—Ä—É–∑–∫–∞ Excel –∏ —Å–æ–∑–¥–∞–Ω–∏–µ preview

**–î–æ—Å—Ç—É–ø:** FOREMAN, HR_MANAGER

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `file` (form-data) ‚Äî Excel —Ñ–∞–π–ª (.xlsx)
- `brigade_id` (query) ‚Äî ID –±—Ä–∏–≥–∞–¥—ã

**–ó–∞–ø—Ä–æ—Å:**
```bash
curl -X POST "http://localhost:8000/api/v1/time-sheets-excel/upload-preview?brigade_id=1" \
  -H "Authorization: Bearer <token>" \
  -F "file=@timesheet.xlsx"
```

**–û—Ç–≤–µ—Ç (—É—Å–ø–µ—Ö):**
```json
{
  "preview_id": "550e8400-e29b-41d4-a716-446655440000",
  "brigade_id": 1,
  "brigade_name": "–ë—Ä–∏–≥–∞–¥–∞ ‚Ññ1",
  "period_start": "2026-01-15",
  "period_end": "2026-01-21",
  "stats": {
    "total_rows": 25,
    "valid_rows": 23,
    "invalid_rows": 2,
    "total_hours": 184.0,
    "overtime_cases": 3,
    "unique_members": 5,
    "unique_objects": 2,
    "has_errors": true,
    "has_warnings": true
  },
  "items": [
    {
      "row_number": 1,
      "member_name": "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω",
      "member_id": 10,
      "member_verified": true,
      "date": "2026-01-15",
      "cost_object_name": "–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –¥–æ–º–∞",
      "cost_object_id": 3,
      "cost_object_verified": true,
      "hours": 8.0,
      "valid": true,
      "errors": [],
      "warnings": []
    },
    {
      "row_number": 2,
      "member_name": "–ü–µ—Ç—Ä–æ–≤ –ü—ë—Ç—Ä",
      "member_id": null,
      "member_verified": false,
      "date": "2026-01-15",
      "cost_object_name": "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ–±—ä–µ–∫—Ç",
      "cost_object_id": null,
      "cost_object_verified": false,
      "hours": 8.0,
      "valid": false,
      "errors": [
        "–°–æ—Ç—Ä—É–¥–Ω–∏–∫ '–ü–µ—Ç—Ä–æ–≤ –ü—ë—Ç—Ä' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±—Ä–∏–≥–∞–¥–µ",
        "–û–±—ä–µ–∫—Ç '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ–±—ä–µ–∫—Ç' –Ω–µ –Ω–∞–π–¥–µ–Ω"
      ],
      "warnings": []
    }
  ],
  "expires_at": 1738004567.123,
  "message": "–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–∑–¥–∞–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É."
}
```

**–û—Ç–≤–µ—Ç (–æ—à–∏–±–∫–∞):**
```json
{
  "detail": "–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ Excel: –ù–µ –Ω–∞–π–¥–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫ '–ü–µ—Ä–∏–æ–¥'"
}
```

---

#### POST /api/v1/time-sheets-excel/confirm-upload

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–∞–±–µ–ª—è –ø–æ—Å–ª–µ preview

**–î–æ—Å—Ç—É–ø:** FOREMAN, HR_MANAGER

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `preview_id` (query) ‚Äî ID preview –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

**–ó–∞–ø—Ä–æ—Å:**
```bash
curl -X POST "http://localhost:8000/api/v1/time-sheets-excel/confirm-upload?preview_id=550e8400..." \
  -H "Authorization: Bearer <token>"
```

**–õ–æ–≥–∏–∫–∞:**
1. –ü–æ–ª—É—á–µ–Ω–∏–µ preview –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (—Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å)
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
4. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã—Ö —Å—Ç—Ä–æ–∫
5. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–µ–ª—è —á–µ—Ä–µ–∑ TimeSheetService
6. –£–¥–∞–ª–µ–Ω–∏–µ preview –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
7. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ audit_log

**–û—Ç–≤–µ—Ç (—É—Å–ø–µ—Ö):**
```json
{
  "id": 42,
  "brigade_id": 1,
  "brigade_name": "–ë—Ä–∏–≥–∞–¥–∞ ‚Ññ1",
  "period_start": "2026-01-15",
  "period_end": "2026-01-21",
  "status": "–ß–ï–†–ù–û–í–ò–ö",
  "hour_rate": null,
  "total_hours": 184.0,
  "total_amount": null,
  "items": [
    {
      "id": 150,
      "member_id": 10,
      "member_name": "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω",
      "date": "2026-01-15",
      "cost_object_id": 3,
      "cost_object_name": "–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –¥–æ–º–∞",
      "hours": 8.0
    }
  ],
  "created_at": "2026-01-26T22:00:00",
  "updated_at": "2026-01-26T22:00:00"
}
```

**–û—Ç–≤–µ—Ç (–æ—à–∏–±–∫–∞):**
```json
{
  "detail": "Preview –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∏—Å—Ç—ë–∫. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∑–∞–Ω–æ–≤–æ."
}
```

```json
{
  "detail": "–í –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å –æ—à–∏–±–∫–∏ (2 —Å—Ç—Ä–æ–∫). –ò—Å–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∑–∞–Ω–æ–≤–æ."
}
```

---

#### GET /api/v1/time-sheets-excel/preview/{preview_id}

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ preview

**–î–æ—Å—Ç—É–ø:** –≤—Å–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ (—Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ preview)

**–ó–∞–ø—Ä–æ—Å:**
```bash
curl "http://localhost:8000/api/v1/time-sheets-excel/preview/550e8400..." \
  -H "Authorization: Bearer <token>"
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
- –ü–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç—å preview –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ preview
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏

---

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª Excel –∑–∞–≥—Ä—É–∑–∫–∏

```
1. –ë—Ä–∏–≥–∞–¥–∏—Ä –∑–∞–≥—Ä—É–∂–∞–µ—Ç Excel
   ‚Üì
   POST /upload-preview?brigade_id=1
   
2. –°–∏—Å—Ç–µ–º–∞ –ø–∞—Ä—Å–∏—Ç –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç
   ‚Üì
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–∞—Å–æ–≤ –∏ –¥–∞—Ç
   - –ü–æ–¥—Å—á—ë—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
   
3. –í–æ–∑–≤—Ä–∞—Ç preview_id –∏ –¥–∞–Ω–Ω—ã—Ö
   ‚Üì
   Frontend –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É:
   - ‚úÖ –í–∞–ª–∏–¥–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ (–∑–µ–ª—ë–Ω—ã–π)
   - ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–∂—ë–ª—Ç—ã–π)
   - ‚ùå –û—à–∏–±–∫–∏ (–∫—Ä–∞—Å–Ω—ã–π)
   
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–∞–Ω–Ω—ã–µ
   ‚Üì
   –ï—Å–ª–∏ –û–ö:
     POST /confirm-upload?preview_id=...
     ‚Üí –¢–∞–±–µ–ª—å —Å–æ–∑–¥–∞–Ω
     ‚Üí Preview —É–¥–∞–ª—ë–Ω
   
   –ï—Å–ª–∏ –ù–ï –û–ö:
     - –ò—Å–ø—Ä–∞–≤–∏—Ç—å Excel
     - –ó–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–Ω–æ–≤–æ (—à–∞–≥ 1)
```

---

## üìä –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –§–ò–û –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —á–ª–µ–Ω–æ–º –±—Ä–∏–≥–∞–¥—ã
- –ü–æ–∏—Å–∫ —Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π
- Trim –ø—Ä–æ–±–µ–ª–æ–≤

**–ü—Ä–∏–º–µ—Ä—ã:**
```
"–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" ‚Üí ‚úÖ member_id: 10
"–∏–≤–∞–Ω–æ–≤ –∏–≤–∞–Ω –∏–≤–∞–Ω–æ–≤–∏—á" ‚Üí ‚úÖ member_id: 10 (case-insensitive)
"  –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω  "       ‚Üí ‚úÖ member_id: 10 (trim)
"–ü–µ—Ç—Ä–æ–≤ –ü—ë—Ç—Ä"          ‚Üí ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω –≤ –±—Ä–∏–≥–∞–¥–µ
```

---

### –û–±—ä–µ–∫—Ç—ã —É—á—ë—Ç–∞

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∞–∫—Ç–∏–≤–Ω—ã–º –æ–±—ä–µ–∫—Ç–æ–º
- –ü–æ–∏—Å–∫ —Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π
- –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã (is_active=True)

**–ü—Ä–∏–º–µ—Ä—ã:**
```
"–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –¥–æ–º–∞"     ‚Üí ‚úÖ cost_object_id: 3
"—Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –¥–æ–º–∞"     ‚Üí ‚úÖ cost_object_id: 3 (case-insensitive)
"–ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ–±—ä–µ–∫—Ç" ‚Üí ‚ùå –û–±—ä–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
```

---

### –ß–∞—Å—ã

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ > 0
- –ú–∞–∫—Å–∏–º—É–º 24 —á–∞—Å–∞
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ > 12 —á–∞—Å–æ–≤

**–ü—Ä–∏–º–µ—Ä—ã:**
```
8.0   ‚Üí ‚úÖ valid
12.5  ‚Üí ‚ö†Ô∏è valid (warning: –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞)
14.0  ‚Üí ‚ö†Ô∏è valid (warning: –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞)
0     ‚Üí ‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤
-2    ‚Üí ‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤
30    ‚Üí ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤
```

---

### –î–∞—Ç—ã

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –§–æ—Ä–º–∞—Ç ISO: YYYY-MM-DD
- –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω–æ–π –¥–∞—Ç–æ–π

**–ü—Ä–∏–º–µ—Ä—ã:**
```
"2026-01-15"  ‚Üí ‚úÖ
"15.01.2026"  ‚Üí ‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞
"2026-13-01"  ‚Üí ‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞
```

---

## üíæ –•—Ä–∞–Ω–∏–ª–∏—â–µ Preview

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:** In-memory (—Å–ª–æ–≤–∞—Ä—å –≤ Python)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```python
{
  "550e8400-e29b-41d4-a716-446655440000": {
    "preview_id": "550e8400...",
    "user_id": 5,
    "brigade_id": 1,
    "items": [...],
    "stats": {...},
    "expires_at": 1738004567.123
  }
}
```

**TTL:** 1 —á–∞—Å (3600 —Å–µ–∫—É–Ω–¥)

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- ‚ùå –î–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
- ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–Ω—Å—Ç–∞–Ω—Å–∞—Ö
- ‚úÖ –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –º–∞–ª—ã—Ö —Å–∏—Å—Ç–µ–º

**–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis
```python
# –ü—Ä–∏–º–µ—Ä —Å Redis
import redis
redis_client = redis.Redis(host='localhost', port=6379)
redis_client.setex(
    f"preview:{preview_id}",
    3600,  # TTL
    json.dumps(preview_data)
)
```

---

## üéØ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –£—Å–ø–µ—à–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –±–µ–∑ –æ—à–∏–±–æ–∫

```bash
# –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ Excel –∏ —Å–æ–∑–¥–∞–Ω–∏–µ preview
POST /upload-preview?brigade_id=1
file: timesheet_perfect.xlsx

# –û—Ç–≤–µ—Ç:
{
  "preview_id": "abc123",
  "stats": {
    "total_rows": 20,
    "valid_rows": 20,
    "invalid_rows": 0,
    "has_errors": false,
    "has_warnings": false
  }
}

# –®–∞–≥ 2: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
POST /confirm-upload?preview_id=abc123

# –û—Ç–≤–µ—Ç:
{
  "id": 42,
  "status": "–ß–ï–†–ù–û–í–ò–ö",
  "total_hours": 160.0,
  "items": [...]
}
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ó–∞–≥—Ä—É–∑–∫–∞ —Å –æ—à–∏–±–∫–∞–º–∏

```bash
# –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ Excel
POST /upload-preview?brigade_id=1
file: timesheet_errors.xlsx

# –û—Ç–≤–µ—Ç:
{
  "preview_id": "def456",
  "stats": {
    "total_rows": 25,
    "valid_rows": 22,
    "invalid_rows": 3,
    "has_errors": true
  },
  "items": [
    {
      "row_number": 5,
      "member_name": "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫",
      "valid": false,
      "errors": ["–°–æ—Ç—Ä—É–¥–Ω–∏–∫ '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±—Ä–∏–≥–∞–¥–µ"]
    }
  ]
}

# –®–∞–≥ 2: –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
POST /confirm-upload?preview_id=def456

# –û—Ç–≤–µ—Ç: –û–®–ò–ë–ö–ê 400
{
  "detail": "–í –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å –æ—à–∏–±–∫–∏ (3 —Å—Ç—Ä–æ–∫). –ò—Å–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∑–∞–Ω–æ–≤–æ."
}

# –®–∞–≥ 3: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç Excel –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞–Ω–æ–≤–æ
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ó–∞–≥—Ä—É–∑–∫–∞ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏ (–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏)

```bash
# –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ Excel
POST /upload-preview?brigade_id=1

# –û—Ç–≤–µ—Ç:
{
  "stats": {
    "valid_rows": 20,
    "invalid_rows": 0,
    "overtime_cases": 3,
    "has_errors": false,
    "has_warnings": true
  },
  "items": [
    {
      "row_number": 12,
      "hours": 14.0,
      "valid": true,
      "warnings": ["–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞: 14 —á–∞—Å–æ–≤ (>12)"]
    }
  ]
}

# –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ù–ï –±–ª–æ–∫–∏—Ä—É—é—Ç –∑–∞–≥—Ä—É–∑–∫—É!

# –®–∞–≥ 2: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (—É—Å–ø–µ—Ö)
POST /confirm-upload?preview_id=...
‚Üí –¢–∞–±–µ–ª—å —Å–æ–∑–¥–∞–Ω —Å –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞–º–∏
```

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

1. **Upload Preview:**
   - –¢–æ–ª—å–∫–æ FOREMAN –∏ HR_MANAGER
   - FOREMAN –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–µ–π –±—Ä–∏–≥–∞–¥—ã

2. **Confirm Upload:**
   - –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å preview (user_id –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è)
   - Preview –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 1 —á–∞—Å

3. **Get Preview:**
   - –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü preview

### –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤

- ‚úÖ –¢–æ–ª—å–∫–æ .xlsx —Ñ–æ—Ä–º–∞—Ç
- ‚úÖ –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ (—É–¥–∞–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
- ‚úÖ –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

---

## üìù –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞—É–¥–∏—Ç–æ–º

**–î–µ–π—Å—Ç–≤–∏–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è:** —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–µ–ª—è –∏–∑ Excel

```json
{
  "action": "CREATE_TIMESHEET_FROM_EXCEL",
  "entity_type": "TimeSheet",
  "entity_id": 42,
  "user_id": 5,
  "description": "–°–æ–∑–¥–∞–Ω —Ç–∞–±–µ–ª—å #42 –∏–∑ Excel (23 —Å—Ç—Ä–æ–∫)"
}
```

---

## ‚ú® –ò—Ç–æ–≥–∏

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ ExcelPreviewService (280 —Å—Ç—Ä–æ–∫)
- ‚úÖ 3 –Ω–æ–≤—ã—Ö API endpoint
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, –æ–±—ä–µ–∫—Ç–æ–≤, —á–∞—Å–æ–≤, –¥–∞—Ç
- ‚úÖ –ü–æ–¥—Å—á—ë—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏, –æ—à–∏–±–∫–∏)
- ‚úÖ –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ preview (TTL 1 —á–∞—Å)
- ‚úÖ –û–±–æ–≥–∞—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (ID –≤–º–µ—Å—Ç–æ –∏–º—ë–Ω)
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª—ã:**
- `app/time_sheets/excel_preview_service.py` ‚Äî –Ω–æ–≤—ã–π
- `app/time_sheets/excel_upload.py` ‚Äî –æ–±–Ω–æ–≤–ª—ë–Ω
- `app/time_sheets/service.py` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω get_brigade_by_id()

**–°—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~400 –Ω–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫

---

## üöÄ –ß—Ç–æ –¥–∞–ª—å—à–µ?

**–ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

1. **–ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ Redis** –¥–ª—è preview —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
2. **WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
3. **–ú–∞—Å—Å–æ–≤–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** —Å—Ç—Ä–æ–∫ –≤ preview
4. **–≠–∫—Å–ø–æ—Ä—Ç preview** –≤ Excel –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

**–°–µ—Ä–≤–µ—Ä:** ‚úÖ http://127.0.0.1:8000  
**Swagger UI:** http://127.0.0.1:8000/docs  
**–ù–æ–≤—ã–µ endpoints:**
- POST `/api/v1/time-sheets-excel/upload-preview`
- POST `/api/v1/time-sheets-excel/confirm-upload`
- GET `/api/v1/time-sheets-excel/preview/{id}`
