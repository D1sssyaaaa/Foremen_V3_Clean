# Сверка системы и вопросы для уточнения

Документ составлен на основе структуры Система.md с учётом последних нововведений. Формулировки — простым языком.

---

## 1) Авторизация и роли
**Описание функции:** вход в систему, назначение ролей, доступ по ролям.
**Статус:** частично реализовано.
**Вопросы и ответы:**
- Нужна ли возможность менять роли любому администратору или только главному?
	Ответ: По сути в системе должен быть только один администратор. Следующая роль с почти полным доступом — руководитель (MANAGER). Её, кажется, ещё нет в системе.
- Нужно ли ограничить саморедактирование ролей (например, чтобы нельзя было снять себя с админа)?
	Ответ: Админка будет выдаваться принудительно первому пользователю, который зарегистрируется в системе через веб.
- Нужны ли настройки уведомлений в профиле для каждой роли?
	Ответ: Да.
- Нужна ли история входов пользователей (кто и когда заходил)?
	Ответ: Нет.
- Нужны ли отдельные права на просмотр/редактирование финансовых данных?
	Ответ: Нужно уточнить.
	Пояснение: это про то, кто может смотреть суммы, бюджеты, отчёты и менять их. Нужны ли отдельные ограничения на финансы?
- Нужны ли временные роли (на период отпуска/замены)?
	Ответ: Нет. Пользователь деактивируется, его роль передаётся другому сотруднику.

---

## 2) Пользователи и профили
**Описание функции:** список пользователей, активность, профиль, привязка Telegram.
**Статус:** частично реализовано.
**Вопросы и ответы:**
- Какие поля профиля обязательны (ФИО, дата рождения, фото)?
	Ответ: ФИО, дата рождения, эл. почта, номер телефона.
- Нужно ли хранить историю изменений профиля?
	Ответ: Нет.
- Нужна ли массовая деактивация/активация пользователей?
	Ответ: Нет.
- Нужна ли функция поиска по пользователям (по имени, телефону)?
	Ответ: Нет.
- Нужна ли блокировка пользователя без удаления?
	Ответ: Да, функция вроде есть — нужно проверить.
- Нужно ли уведомлять пользователя при изменении его ролей?
	Ответ: Нет.

---

## 3) Объекты учёта
**Описание функции:** справочник объектов, карточки, статистика и отчёты по объекту.
**Статус:** реализовано частично.
**Вопросы и ответы:**
- Должны ли бригадиры видеть только “свои” объекты?
	Ответ: Да.
- Нужны ли статусы объекта (активен/готовится к закрытию/закрыт/архив)?
	Ответ: Да.
- Нужны ли вложения/документы в карточке объекта?
	Ответ: Нет.
- Нужны ли ответственные лица по объекту (главный/заместитель)?
	Ответ: Да. Нужна возможность запрашивать доступ к объекту через Telegram и согласование доступа руководителем через Telegram.
- Нужен ли бюджет по объекту с лимитами и предупреждениями?
	Ответ: Пока не ясно.
	Пояснение: это когда у объекта есть бюджет, и система предупреждает, если расходы приближаются к лимиту. Нужно ли это?
- Нужно ли скрывать закрытые/архивные объекты по умолчанию?
	Ответ: Да.

---

## 4) Табели РТБ (учёт времени)
**Описание функции:** бригадир подаёт табель, HR проверяет и утверждает, расчёт ФОТ.
**Статус:** реализовано частично.
**Вопросы и ответы:**
- Нужна ли правка табеля после отправки на проверку?
	Ответ: Не заполнено.
- Нужно ли хранить комментарии HR к каждой правке?
	Ответ: Не заполнено.
- Какой процесс для Excel-табелей: только загрузка или ещё валидация и предпросмотр?
	Ответ: Не заполнено.
- Нужен ли отчёт по ФОТ с разбивкой по объектам?
	Ответ: Не заполнено.
- Нужна ли автопроверка “переработок” (например, > 12 часов в день)?
	Ответ: Не заполнено.
- Нужен ли запрет на отрицательные/нулевые часы?
	Ответ: Не заполнено.
- Нужна ли печатная форма табеля?
	Ответ: Не заполнено.

---

## 5) Заявки на технику и инструмент
**Описание функции:** создание заявки, утверждение, учёт часов, расчёт стоимости.
**Статус:** реализовано частично.
**Нововведение:** добавлен запрос на отмену заявки из Telegram с указанием причины.
**Вопросы и ответы:**
- Можно ли отменять заявку в любом статусе или только в “Новая/Утверждена”?
	Ответ: Можно и в статусе “В работе”, если ухудшилась погода. Тогда бот должен спрашивать про штраф.
- Нужно ли подтверждение отмены менеджером (двухэтапная отмена) — да/нет?
	Ответ: Да.
- Нужно ли хранить отдельные поля “доставка” и “штраф” в стоимости?
	Ответ: Да.
- Как должен выглядеть итоговый расчёт суммы (формула)?
	Ответ: Часы × стоимость часа + доставка + штраф (если есть).
- Нужна ли дата/время начала работ и фактического завершения?
	Ответ: Нужна дата и время начала работ.
- Нужно ли назначать поставщика до утверждения?
	Ответ: Да, поставщик указывается сразу, и без него статус не меняется.
- Нужны ли напоминания менеджеру, если заявка долго без решения?
	Ответ: Да, уведомление в Telegram.

---

## 6) Заявки на материалы
**Описание функции:** создание, согласование, обработка, заказ, поставка, закрытие.
**Статус:** реализовано частично.
**Нововведение:** выровнены статусы с русскими значениями в интерфейсе.
**Вопросы и ответы:**
- Нужен ли статус “Отклонена” для заявок на материалы?
	Ответ: Да.
- Кто может закрывать заявку вручную?
	Ответ: Пока не ясно.
	Пояснение: это вопрос, кто имеет право нажать “Закрыть заявку” — только менеджер по материалам или ещё кто-то?
- Должно ли быть автоматическое закрытие при полной поставке?
	Ответ: Да, но только после того как все УПД прикреплены к заявке.
- Нужен ли контроль остатков по каждой позиции заявки?
	Ответ: Нет.
- Нужна ли возможность частичного отказа по позиции (не весь заказ)?
	Ответ: Да.
- Нужны ли единицы измерения по справочнику (и запрет “свободного текста”)?
	Ответ: Нет.
- Нужен ли приоритет/срочность по умолчанию?
	Ответ: Нет.

---

## 7) УПД (XML) — загрузка и распределение
**Описание функции:** загрузка XML, парсинг, распределение по заявкам и объектам, формирование затрат.
**Статус:** реализовано частично.
**Вопросы и ответы:**
- Где должны храниться XML: локально или в S3/MinIO?
	Ответ: Локально.
- Нужны ли ограничения на размер XML и число строк?
	Ответ: Нет.
- Нужен ли архив УПД и возможность повторного распределения?
	Ответ: Архив нужен. Если объект в архиве — все УПД по нему тоже в архив.
- Нужны ли отчёты по ошибкам парсинга для бухгалтера?
	Ответ: Да, чтобы при ошибках бухгалтер мог вводить данные вручную.
- Нужна ли проверка дубликатов УПД по номеру/дате/поставщику?
	Ответ: Да.
- Нужно ли хранить оригинальный XML как “неизменяемый файл”?
	Ответ: Нет.
- Нужна ли ручная корректировка распарсенных строк до распределения?
	Ответ: Да.

---

## 8) Затраты и общая аналитика
**Описание функции:** сводные отчёты, аналитика по объектам и периодам.
**Статус:** частично реализовано.
**Вопросы и ответы:**
- Какие ключевые отчёты обязательны в первой версии?
	Ответ: Затраченные средства по объекту, сколько было в бюджете и сколько осталось.
- Нужен ли экспорт (Excel/PDF) и в каком формате?
	Ответ: Да, Excel.
- Нужны ли графики по видам затрат (материалы/техника/ФОТ)?
	Ответ: Да.
- Нужен ли отчёт “план/факт” по объектам?
	Ответ: Да.
- Нужна ли детализация до уровня документа (УПД) в отчётах?
	Ответ: Пока не ясно.
	Пояснение: это когда можно в отчёте раскрыть сумму до конкретного УПД (номер, дата, поставщик). Нужна ли такая детализация?
- Нужны ли фильтры по ответственным лицам?
	Ответ: Нет.

---

## 9) Уведомления
**Описание функции:** уведомления в web и Telegram о смене статусов.
**Статус:** реализовано частично.
**Вопросы и ответы:**
- Какие события точно должны присылаться в Telegram?
	Ответ: Все изменения статусов заявок, принятие или отклонение заявок.
- Нужна ли настройка “тихие часы”?
	Ответ: Да, с 22:00 до 7:00.
- Нужны ли WebSocket‑уведомления в веб‑интерфейсе?
	Ответ: Да, в вебе должны быть рабочие уведомления обо всех событиях.
- Нужны ли уведомления на e‑mail?
	Ответ: Нет.
- Нужен ли список “непрочитанных уведомлений” в веб‑интерфейсе?
	Ответ: Да.
- Нужно ли хранить историю уведомлений за 6–12 месяцев?
	Ответ: Да.

---

## 10) Telegram‑бот
**Описание функции:** создание заявок, подача табелей, просмотр своих заявок.
**Статус:** реализовано частично.
**Нововведение:** отмена заявки на технику с указанием причины.
**Вопросы и ответы:**
- Нужна ли команда “Мои активные заявки” отдельно от “Мои заявки”?
	Ответ: Да.
- Нужна ли возможность редактировать заявку до утверждения?
	Ответ: Да.
- Нужно ли подтверждение отмены через кнопку перед отправкой причины?
	Ответ: Да.
- Нужны ли быстрые шаблоны для повторной заявки?
	Ответ: Нет.
- Нужны ли подсказки по вводу (пример формата материалов/дат)?
	Ответ: Нет.
- Нужна ли отдельная команда “Помощь по статусам”?
	Ответ: Нет.

---

## 11) Безопасность и доступ
**Описание функции:** проверка ролей на каждом действии, защита от ошибочных действий.
**Статус:** частично реализовано.
**Вопросы и ответы:**
- Нужен ли аудит всех критичных изменений (лог действий)?
	Ответ: Пока не ясно.
	Пояснение: это журнал “кто и что изменил” (например: кто утвердил заявку, кто изменил роль).
- Нужны ли лимиты (rate limit) на загрузку УПД?
	Ответ: Пока не ясно.
	Пояснение: это ограничение, чтобы нельзя было загрузить слишком много УПД за короткое время.
- Нужно ли блокировать подозрительные XML файлы?
	Ответ: Пока не ясно.
	Пояснение: это файлы, которые выглядят как повреждённые или с неверной структурой.
- Нужна ли двухфакторная авторизация для администраторов?
	Ответ: Нет.
- Нужно ли логировать все попытки входа (успех/ошибка)?
	Ответ: Да.
- Нужны ли регулярные резервные копии базы данных?
	Ответ: Да, раз в неделю. Нужна авто‑очистка старых бэкапов, чтобы не занимать место на диске.

---

## 12) Инфраструктура и запуск
**Описание функции:** запуск backend, frontend, bot, окружение.
**Статус:** реализовано частично.
**Вопросы и ответы:**
- Переходим на PostgreSQL + Redis или остаёмся на SQLite для MVP?
	Ответ: Пока не ясно.
	Пояснение: SQLite проще, но хуже для многопользовательской работы. PostgreSQL надёжнее для боевой версии.
- Нужна ли контейнеризация Docker для запуска в 1 клик?
	Ответ: Да, чтобы можно было скопировать проект на флешку и развернуть у партнёров.
- Должны ли скрипты запуска поднимать всё сразу (backend+frontend+bot)?
	Ответ: Да.
- Нужен ли отдельный тестовый контур (копия базы для проверки)?
	Ответ: Пока не ясно.
	Пояснение: это отдельная “тестовая база”, чтобы проверять новые функции без риска для рабочих данных.
- Нужны ли инструкции для развертывания на сервере (Linux)?
	Ответ: Да.
- Нужны ли автоматические обновления (pull + restart)?
	Ответ: Пока не ясно.
	Пояснение: это кнопка/скрипт, который сам подтягивает новую версию и перезапускает систему.

---

## Нововведения, которые уже учтены
- Исправлены статусы в интерфейсе материалов (используются русские статусы).
- Исправлены статусы в интерфейсе техники (русские значения).
- Добавлена отмена заявки на технику в Telegram с вводом причины.
- Улучшено отображение ошибок при изменении ролей и статусов.

---

## Идеи улучшений (по желанию)
- История изменений заявок (кто и когда изменил статус).
- Отдельный экран “Проблемы УПД” с фильтрами.
- Шаблоны заявок (повторить прошлую заявку в 1 клик).
- Умные подсказки материалов по истории заказов.

---

## Вопросы в формате теста (выберите вариант ответа)

### Раздел 1: Авторизация и роли

**Вопрос 1.1** Нужны ли отдельные права на просмотр/редактирование финансовых данных?
- [ ] A. Да, нужны отдельные права на финансы (только некоторые роли могут видеть и менять суммы)
- [x] B. Нет, если есть доступ к заявке/объекту — видны все суммы
- [ ] C. Только просмотр ограничить (редактировать могут все, смотреть — избранные)

_Пояснение:_ Это про то, кто может смотреть бюджеты объектов, итоговые суммы в заявках и отчётах. Если выбрать А, то нужно будет прописать роль "финансист" или добавить признак в имеющиеся роли.

_Комментарий:_ Финансовые данные доступны всем, у кого есть доступ к заявке/объекту

---

### Раздел 3: Объекты учёта

**Вопрос 3.1** Нужен ли бюджет по объекту с лимитами и предупреждениями?
- [x] A. Да, нужен бюджет с предупреждением, когда расходы > 80% бюджета
- [ ] B. Да, но без предупреждений (просто отображать факт/план)
- [ ] C. Нет, не нужен

_Пояснение:_ Вариант А — система будет уведомлять руководителя/бухгалтера, когда объект израсходовал 80% от бюджета. Вариант B — только показываем цифры, без уведомлений.

_Комментарий:_ Обязательно нужно! Уведомления должны приходить: 1. Руководителю 2. Бухгалтеру

---

### Раздел 4: Табели РТБ

**Вопрос 4.1** Нужна ли правка табеля после отправки на проверку?
- [x] A. Да, бригадир может редактировать до утверждения HR
- [ ] B. Нет, после отправки только HR может вернуть на доработку
- [ ] C. Только HR может править сразу (без возврата бригадиру)

_Пояснение:_ Вариант А — бригадир отправил табель, потом вспомнил ошибку и может исправить. Вариант B — только HR возвращает с комментарием "исправьте вот это", бригадир правит. Вариант C — HR сам исправляет напрямую.

_Комментарий:_ Бригадир отправил РТБ → Бригадир заметил ошибку → Бригадир отменил табель → Бригадир исправил ошибки → Бригадир повторно отправил табель на согласование.

**Вопрос 4.2** Нужно ли хранить комментарии HR к каждой правке?
- [x] A. Да, история всех комментариев
- [ ] B. Нет, достаточно последнего комментария
- [ ] C. Не нужны комментарии вообще

_Пояснение:_ Вариант А — бригадир увидит всю историю: "1-й раз вернули — мало часов, 2-й раз — опечатка в дате" и т.д. Вариант B — только текущий комментарий.

_Комментарий:_ Так же Бригадиру должен приходить уведомление в Telegram об этом комментарии.

**Вопрос 4.3** Какой процесс для Excel-табелей: только загрузка или ещё валидация и предпросмотр?
- [ ] A. Только загрузка, система сама парсит и сохраняет
- [x] B. Загрузка + предпросмотр (показать данные, потом "сохранить")
- [ ] C. Загрузка + проверка ошибок (если ошибки — отклонить файл)

_Пояснение:_ Вариант А — загрузили Excel, система автоматически создала табель. Вариант B — после загрузки показываем таблицу: "Всё правильно? Да/Нет". Вариант C — если в файле ошибки (неверная дата, отрицательные часы) — не принимаем.

_Комментарий:_ Предпросмотр обязателен

**Вопрос 4.4** Нужен ли отчёт по ФОТ с разбивкой по объектам?
- [x] A. Да, нужен отчёт "ФОТ по объектам за период"
- [ ] B. Нет, достаточно общего отчёта по затратам

_Пояснение:_ Вариант А — отдельный отчёт, где видно: Объект 1 — ФОТ 500 000 руб, Объект 2 — ФОТ 300 000 руб и т.д.

_Комментарий:_ Обязательно нужен

**Вопрос 4.5** Нужна ли автопроверка "переработок" (например, > 12 часов в день)?
- [ ] A. Да, запретить сохранение табеля, если > 12 часов в день
- [x] B. Да, но только предупреждение (можно сохранить)
- [ ] C. Нет, не нужна проверка

_Пояснение:_ Вариант А — система не даст отправить табель, если где-то указано 13 часов в день. Вариант B — покажет предупреждение, но отправить можно.

_Комментарий:_ Такие строчки должны помечаться (выделяться цветом/пометкой)

**Вопрос 4.6** Нужен ли запрет на отрицательные/нулевые часы?
- [ ] A. Да, запретить отрицательные и нулевые
- [x] B. Нулевые разрешить, отрицательные запретить
- [ ] C. Не нужен запрет

_Пояснение:_ Вариант А — в табеле не может быть 0 часов или минус. Вариант B — можно указать 0 (человек не работал), но минус нельзя.

_Комментарий:_ 0 разрешено, минус запрещен

**Вопрос 4.7** Нужна ли печатная форма табеля?
- [x] A. Да, кнопка "Печать" (PDF или Excel)
- [ ] B. Нет

_Пояснение:_ Это для случаев, когда нужно распечатать табель на бумаге или отправить файл кому-то.

_Комментарий:_ Только в формате Excel

---

### Раздел 6: Заявки на материалы

**Вопрос 6.1** Кто может закрывать заявку на материалы вручную?
- [x] A. Только менеджер по материалам (MATERIALS_MANAGER)
- [ ] B. Менеджер по материалам + руководитель (MANAGER)
- [ ] C. Любой, кто имеет доступ к объекту

_Пояснение:_ Речь про кнопку "Закрыть заявку". Вариант А — только специалист по материалам. Вариант B — ещё и главный руководитель. Вариант C — все причастные.

_Комментарий:_ Только MATERIALS_MANAGER

---

### Раздел 8: Затраты и аналитика

**Вопрос 8.1** Нужна ли детализация до уровня документа (УПД) в отчётах?
- [x] A. Да, в отчёте должна быть возможность раскрыть сумму до конкретного УПД
- [ ] B. Нет, достаточно общей суммы по типу затрат

_Пояснение:_ Вариант А — в отчёте можно кликнуть на "Материалы: 100 000 руб" и увидеть список: УПД №123 от 10.01 — 50 000 руб, УПД №456 от 15.01 — 50 000 руб. Вариант B — просто итоговая сумма.

_Комментарий:_ Детализация обязательна

---

### Раздел 11: Безопасность

**Вопрос 11.1** Нужен ли аудит всех критичных изменений (лог действий)?
- [x] A. Да, журнал "кто, что, когда изменил" для всех важных действий
- [ ] B. Нет, не нужен

_Пояснение:_ Журнал аудита записывает: "Иванов И.И. утвердил заявку №123 в 14:30 25.01.2026", "Петров П.П. изменил роль пользователя Сидоров С.С. с FOREMAN на MANAGER в 10:00 26.01.2026" и т.д.

_Комментарий:_ Аудит обязателен

**Вопрос 11.2** Нужны ли лимиты (rate limit) на загрузку УПД?
- [ ] A. Да, не более 10 УПД в минуту от одного пользователя
- [ ] B. Да, но другой лимит (укажите в комментарии)
- [x] C. Нет, не нужен

_Пояснение:_ Это защита от случайной или вредоносной массовой загрузки. Вариант А — если бухгалтер пытается загрузить 100 файлов подряд, система замедлит/заблокирует.

_Комментарий:_ Лимиты не нужны

**Вопрос 11.3** Нужно ли блокировать подозрительные XML файлы?
- [ ] A. Да, если файл повреждён или структура неверна — не загружать
- [x] B. Загружать, но пометить как "ошибка парсинга"
- [ ] C. Не нужна блокировка

_Пояснение:_ Вариант А — система проверяет XML перед загрузкой и отклоняет "сломанные" файлы. Вариант B — загружаем любой файл, но если не парсится — показываем ошибку и даём возможность ввести данные вручную.

_Комментарий:_ Загружать с пометкой ошибки

---

### Раздел 12: Инфраструктура

**Вопрос 12.1** Переходим на PostgreSQL + Redis или остаёмся на SQLite для MVP?
- [x] A. PostgreSQL + Redis (для надёжности и многопользовательской работы)
- [ ] B. SQLite (для простоты развёртывания)
- [ ] C. SQLite сейчас, PostgreSQL потом

_Пояснение:_ PostgreSQL лучше для реальной работы с несколькими пользователями одновременно. SQLite проще в установке (один файл), но хуже работает при многопользовательском доступе. Вариант C — начнём с SQLite, потом мигрируем.

_Комментарий:_ PostgreSQL + Redis

**Вопрос 12.2** Нужен ли отдельный тестовый контур (копия базы для проверки)?
- [x] A. Да, тестовая база для проверки новых функций
- [ ] B. Нет, тестируем на рабочей базе аккуратно
- [ ] C. Использовать Docker-контейнер для тестов (создаётся и удаляется)

_Пояснение:_ Вариант А — отдельная база данных, где можно "поиграться" без риска. Вариант C — запускаем тестовую версию в Docker, проверяем, потом удаляем контейнер.

_Комментарий:_ Тестовая база обязательна

**Вопрос 12.3** Нужны ли автоматические обновления (pull + restart)?
- [x] A. Да, кнопка/скрипт "Обновить систему"
- [ ] B. Нет, обновляем вручную (через git pull и перезапуск)
- [ ] C. Автообновления только для Docker-версии

_Пояснение:_ Вариант А — один клик и система сама подтягивает новую версию с GitHub, перезапускается. Вариант B — обновляем по инструкции вручную. Вариант C — если используем Docker, то просто пересоздаём контейнер с новым образом.

_Комментарий:_ Автообновление обязательно

---

## Что мне от вас нужно дальше
Пожалуйста:
1. Выберите варианты ответов (поставьте `x` в квадратные скобки, например `[x]`)
2. Добавьте комментарии, если есть уточнения
3. После заполнения я составлю подробный план разработки