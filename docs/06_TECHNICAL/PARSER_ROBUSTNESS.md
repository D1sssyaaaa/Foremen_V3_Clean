# УПД Парсер: Система отслеживания проблем

## Обзор

Парсер УПД теперь имеет встроенную систему отслеживания проблем при парсинге. Это позволяет:

✓ Отслеживать и логировать все проблемы, возникающие при парсинге
✓ Видеть какой генератор вызвал проблему
✓ Отслеживать неполные или необычные данные
✓ Подготовиться к будущим изменениям форматов
✓ Разрабатывать специфичные для генератора обработчики

## Категории проблем

### 1. **INFO** (Информационные)
Данные обработаны, но обнаружены необычные структуры:
- "Обнаружена услуга без явной цены/кол-во" - случаи, когда товар парсится как услуга
- "ИНН не найден в имени поставщика" - имя без ИНН

### 2. **WARNING** (Предупреждения)
Данные обработаны, но есть отсутствующие или неполные атрибуты:
- "Элемент ... не найден" - требуемый элемент отсутствует
- "Атрибут ... не найден в строке" - проблема с парсингом структурированных данных

### 3. **ERROR** (Критические)
Данные не обработаны или обработаны с серьёзными потерями:
- Ошибки парсинга XML
- Невозможно извлечь критически важные данные

## API парсера

### Структура результатов парсинга

```python
doc = UPDDocument(
    document_number: str,
    document_date: str,
    supplier_name: str,
    supplier_inn: str,
    items: List[UPDItem],
    total_without_vat: float,
    total_vat: float,
    total_with_vat: float,
    item_count: int,
    xml_version: str,
    generator: str,
    parsing_status: str,  # "SUCCESS" или "SUCCESS_WITH_N_ISSUES"
    parsing_issues: List[dict]  # Список обнаруженных проблем
)
```

### Структура parsing_issues

Каждая проблема - это словарь с полями:

```python
{
    'severity': str,    # 'info', 'warning', 'error'
    'element': str,     # Название элемента/атрибута, где возникла проблема
    'message': str,     # Описание проблемы
    'generator': str,   # Какой генератор вызвал проблему
    'value': str        # (опционально) Что было получено вместо ожидаемого
}
```

## Примеры использования

### Получить проблемы конкретного файла

```python
from upd_parser import UPDParser

parser = UPDParser('file.xml')
doc = parser.parse()

if doc.parsing_issues:
    print(f"Найдено {len(doc.parsing_issues)} проблем:")
    for issue in doc.parsing_issues:
        print(f"  [{issue['severity']}] {issue['element']}: {issue['message']}")
```

### Web API

**GET /api/document-details/{filename}**

Ответ включает поле `parsing_issues`:

```json
{
  "filename": "...",
  "parsing_issues": [
    {
      "severity": "info",
      "element": "СведТов",
      "message": "Обнаружена услуга без явной цены/кол-во, установлено qty=1",
      "generator": "1С:Предприятие 8",
      "value": ""
    }
  ]
}
```

**GET /api/parse-directory**

Ответ включает статистику:

```json
{
  "total_files": 19,
  "successful": 18,
  "failed": 0,
  "files_with_issues": 3,
  "documents": [
    {
      "filename": "...",
      "parsing_issues_count": 1,
      "parsing_status_detailed": "SUCCESS_WITH_1_ISSUES"
    }
  ]
}
```

## Обнаруженные генераторы

### 1. 1С:Предприятие 8 (6 файлов)
**Известные особенности:**
- Использует нестандартные коды OCÉИ (например, 356 = "ч"/час)
- Организация в формате: 'ООО "NAME", ИНН/КПП INNVAL/KPPVAL' (с запятой)
- Услуги без КолТов/ЦенаТов обычны

**Обнаруженные проблемы:**
- ИНН не найден в имени (парсит как комбинированное поле)
- Услуги без явных цены/кол-во требуют специальной обработки

### 2. Elewise LegalDoc 2.1 (8 файлов)
**Известные особенности:**
- Наиболее стандартные и предсказуемые
- Все необходимые атрибуты обычно присутствуют
- Минимум неожиданных структур

**Обнаруженные проблемы:**
- Практически нет (наиболее совместимый генератор)

### 3. Diadoc 1.0 (3 файла)
**Известные особенности:**
- Облачная система от компании Диадок
- Может иметь собственные расширения

**Обнаруженные проблемы:**
- Требует дополнительного исследования

### 4. VO2_xslt (2 файла)
**Известные особенности:**
- Неизвестное происхождение
- Потенциально может быть XSLT-генератор

**Обнаруженные проблемы:**
- Требует дополнительного исследования

## Защита от будущих изменений

### Как парсер защищен от неизвестных генераторов

1. **Graceful Degradation** - парсер не падает, а логирует проблемы
2. **Fallback механизмы** - несколько способов извлечь одни и те же данные
3. **Логирование проблем** - все необычное записывается для анализа
4. **Версионирование** - парсер версии 2.0+ поддерживает отслеживание

### Что делать при возникновении новых форматов

1. **Проверить parsing_issues** - там найдутся подсказки о том, что не сработало
2. **Добавить специфичный обработчик** - в `_parse_sved_tov*` методы
3. **Добавить в логирование** - чтобы отслеживать частоту проблемы
4. **Добавить OCÉИ коды** - если используются новые коды

## Как добавить поддержку новых форматов

### Пример: Поддержка нового генератора

```python
# В методе parse():
generator = self._detect_generator(root)

if generator == 'NewGenerator 1.0':
    # Специфичная логика
    supplier_name, supplier_inn = self._extract_supplier_newgen(doc_elem)
else:
    # Обычная логика
    supplier_name, supplier_inn = self._extract_supplier(doc_elem, generator)
```

### Пример: Логирование новой проблемы

```python
def _parse_sved_tov(self, sved_elem, generator: str = ''):
    product_name = sved_elem.get('НаимТов')
    if not product_name:
        self.add_issue('warning', 'НаимТов', 
                     'Название товара не найдено', generator)
```

## Мониторинг

### Проверка статистики проблем

Используйте web интерфейс:
1. Откройте http://127.0.0.1:8000/
2. Нажмите "Загрузить все файлы"
3. Смотрите статистику "С проблемами"
4. Кликните на файл для деталей

### Экспорт проблем

```python
results = parse_all_upd_files(directory)

# Собрать все проблемы по типам
problems_by_severity = {}
for filename, doc in results:
    for issue in (doc.parsing_issues or []):
        severity = issue['severity']
        if severity not in problems_by_severity:
            problems_by_severity[severity] = []
        problems_by_severity[severity].append({
            'file': filename,
            'element': issue['element'],
            'message': issue['message']
        })
```

## Версионирование парсера

**Текущая версия: 2.0**

**История версий:**
- v1.0 - Базовый парсер без отслеживания проблем
- v2.0 - Добавлено отслеживание проблем, поддержка генераторов, graceful degradation

**Будущие версии:**
- v2.1 - Поддержка VO2_xslt генератора
- v2.2 - Специфичные обработчики для Diadoc
- v3.0 - Автоматическое обнаружение новых форматов

## Заключение

Система отслеживания проблем делает парсер более **надежным и предсказуемым** при столкновении с неизвестными форматами. Вместо молчаливого отказа или неправильного парсинга, все проблемы логируются и могут быть проанализированы.

Это особенно важно для долгосрочного поддержания парсера при смене форматов стандарта УПД.
