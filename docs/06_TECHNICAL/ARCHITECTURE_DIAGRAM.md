# Архитектурная диаграмма системы запроса доступа

## 1. Полный поток запроса доступа

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          БРИГАДИР (FOREMAN)                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  Telegram Bot                              Web UI (React)                │
│  ┌─────────────────┐                      ┌──────────────────┐          │
│  │ /request-access │                      │ Запрос доступа   │          │
│  │                 │                      │                  │          │
│  │ 1. Загрузить    │                      │ 1. Выбор объекта │          │
│  │    объекты      │                      │ 2. Ввод причины  │          │
│  │ 2. Выбрать      │ ────────────┬─────→ │ 3. История       │          │
│  │    объект       │    API Вызов │        │    запросов      │          │
│  │ 3. Ввести       │             │        └──────────────────┘          │
│  │    причину      │             │                                      │
│  │ 4. Отправить    │             │                                      │
│  │    запрос       │             │                                      │
│  └─────────────────┘             │                                      │
│                                  │                                      │
│  /my-requests                    │                                      │
│  ┌─────────────────┐             │                                      │
│  │ Мои запросы     │◄────────────┴─ API Response                       │
│  │ - PENDING       │                                                    │
│  │ - APPROVED      │                                                    │
│  │ - REJECTED      │                                                    │
│  └─────────────────┘                                                    │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
                ┌──────────────────────────────────┐
                │    Backend API (FastAPI)         │
                │                                  │
                │ POST /objects/{id}/request-access│
                │ ├─ Создать запрос                │
                │ ├─ Проверить дубликат            │
                │ └─ Сохранить в БД                │
                │                                  │
                │ GET /objects/access-requests/my  │
                │ └─ Вернуть запросы пользователя  │
                │                                  │
                │ GET /objects/{id}/access-        │
                │     requests (MANAGER)           │
                │ └─ Вернуть все запросы объекта   │
                │                                  │
                │ POST .../approve (MANAGER)       │
                │ └─ Одобрить запрос               │
                │                                  │
                │ POST .../reject (MANAGER)        │
                │ └─ Отклонить запрос              │
                │                                  │
                └──────────────────────────────────┘
                              │
                              ▼
                   ┌──────────────────────┐
                   │   PostgreSQL БД      │
                   │                      │
                   │ object_access_       │
                   │ requests table       │
                   │                      │
                   │ id, foreman_id,      │
                   │ object_id, status,   │
                   │ reason, created_at   │
                   │                      │
                   └──────────────────────┘
                              │
                              ▼
                   ┌──────────────────────┐
                   │      МЕНЕДЖЕР        │
                   │    (MANAGER)         │
                   │                      │
                   │ Управление запросами:│
                   │ • Одобрить           │
                   │ • Отклонить          │
                   │ • Фильтровать        │
                   │ • Просмотреть        │
                   │   статистику         │
                   │                      │
                   └──────────────────────┘
```

## 2. FSM диаграмма (Telegram Bot)

```
┌─────────────────────────────────────────────────────────────┐
│                     TELEGRAM BOT FSM                         │
└─────────────────────────────────────────────────────────────┘

                    /request-access
                          │
                          ▼
              ┌───────────────────────┐
              │ waiting_for_object    │
              │                       │
              │ Показать список       │
              │ объектов (inline kb)  │
              └───────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │ (выбор объекта) │ (отмена)        │
        ▼                 ▼
   req_obj:N          cancel_access
        │                 │
        ▼                 ▼
┌──────────────────┐  ┌────────────┐
│waiting_for_reason│  │ Выход      │
│                  │  │ Меню       │
│Показать форму    │  └────────────┘
│для причины       │
│(опционально)     │
└──────────────────┘
        │
    ┌───┴───┬──────────┐
    │       │          │
skip  reason  отмена
    │       │          │
    ▼       ▼          ▼
 API Call  API Call  Выход
    │       │          │
    ▼       ▼          ▼
 Успех    Успех      Меню
```

## 3. Компоненты React

```
┌───────────────────────────────────────────────────────────────┐
│                    App.tsx (Router)                            │
└───────────────────────────────────────────────────────────────┘
                            │
            ┌───────────────┼───────────────┐
            │               │               │
            ▼               ▼               ▼
    ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
    │ ProfilePage  │  │ObjectAccess   │  │AdminAccess   │
    │(существует)  │  │Request.tsx    │  │Requests.tsx  │
    └──────────────┘  │(FOREMAN)      │  │(MANAGER)     │
                      └──────────────┘  └──────────────┘
                                │              │
                                ▼              ▼
                        ┌─────────────┐  ┌──────────────┐
                        │ Форма запр. │  │Админ панель   │
                        │ История     │  │Фильтры       │
                        │ Статусы     │  │Модальные окна│
                        └─────────────┘  └──────────────┘

API Layer:
┌─────────────────────────────────────────────────────────┐
│                    useAuth() Hook                         │
│        - Получение токена авторизации                   │
│        - Управление сессией                              │
└─────────────────────────────────────────────────────────┘
                            │
                    fetch() с Bearer Token
                            │
            ┌───────────────┴───────────────┐
            │                               │
    GET /objects/                  POST /objects/{id}/
    GET /access-requests/my         request-access
    POST .../approve                GET /access-requests
    POST .../reject                 / (для админа)
```

## 4. База данных - Таблица object_access_requests

```
┌─────────────────────────────────────────────────────────────┐
│           object_access_requests table                       │
├────────┬──────────┬──────────┬─────────┬──────────────┬──────┤
│ id     │foreman_id│object_id │ status  │ reason       │ ...  │
├────────┼──────────┼──────────┼─────────┼──────────────┼──────┤
│ 1      │ 5        │ 1        │PENDING  │"Проверка"    │      │
│ 2      │ 5        │ 2        │APPROVED │ NULL         │      │
│ 3      │ 6        │ 1        │REJECTED │ NULL         │ "..."│
└────────┴──────────┴──────────┴─────────┴──────────────┴──────┘

Связи с другими таблицами:

object_access_requests
         │
    ┌────┴────┬────────────┐
    │          │            │
    ▼          ▼            ▼
  users    cost_objects  (rejection_reason)
 (foreman)  (object)     (if REJECTED)

object_foremen (junction table для кэша)
    │
    ├─ object_id
    ├─ foreman_id
    └─ (created_at)
```

## 5. Состояния запроса

```
┌──────────────┐
│ PENDING (⏳) │  <- Начальное состояние после создания
└──────┬───────┘
       │
   ┌───┴────────────────────────┐
   │ Менеджер принимает решение │
   └───┬────────────────────────┘
       │
    ┌──┴────────────────┐
    │                   │
    ▼                   ▼
┌─────────────┐   ┌──────────────┐
│APPROVED (✅)│   │REJECTED (❌) │
└─────────────┘   └──────────────┘
   │                   │
   │                   ▼
   │          rejection_reason
   │          (обязательная при отклонении)
   │
   ▼
 Бригадир получает
 уведомление через:
 • Telegram
 • Web UI
 • Email (опционально)
```

## 6. Поток обработки запроса

```
ФАЗА 1: СОЗДАНИЕ ЗАПРОСА
┌────────────────────────┐
│ Бригадир нажимает:     │
│ "🏗️ Запросить доступ"  │
└────────┬───────────────┘
         │
         ▼
┌────────────────────────┐
│ Загрузка списка        │
│ объектов с API         │
│ GET /objects/          │
└────────┬───────────────┘
         │
         ▼
┌────────────────────────┐
│ Выбор объекта          │
│ (inline клавиатура)    │
└────────┬───────────────┘
         │
         ▼
┌────────────────────────┐
│ Опциональный ввод      │
│ причины запроса        │
└────────┬───────────────┘
         │
         ▼
┌────────────────────────────────────┐
│ Отправка запроса на backend:       │
│ POST /objects/{id}/request-access  │
│ Body: { reason: "..." }            │
└────────┬───────────────────────────┘
         │
         ▼
┌────────────────────────┐
│ Создание записи в БД   │
│ status = 'PENDING'     │
└────────┬───────────────┘
         │
         ▼
┌────────────────────────┐
│ ✅ Успешно!            │
│ Показать подтверждение │
└────────────────────────┘

ФАЗА 2: ПРОСМОТР СТАТУСА
┌────────────────────────┐
│ Бригадир:              │
│ /my-requests           │
└────────┬───────────────┘
         │
         ▼
┌────────────────────────────────────┐
│ Загрузка запросов:                 │
│ GET /objects/access-requests/my    │
└────────┬───────────────────────────┘
         │
         ▼
┌────────────────────────┐
│ Отображение списка:    │
│ - PENDING              │
│ - APPROVED (с датой)   │
│ - REJECTED (с причиной)│
└────────────────────────┘

ФАЗА 3: ОБРАБОТКА МЕНЕДЖЕРОМ
┌────────────────────────┐
│ Менеджер открывает:    │
│ "Управление запросами" │
└────────┬───────────────┘
         │
         ▼
┌────────────────────────────────────┐
│ Загрузка запросов:                 │
│ GET /objects/{id}/access-requests  │
└────────┬───────────────────────────┘
         │
         ▼
┌────────────────────────┐
│ Выбор объекта         │
│ Фильтрация по статусам│
└────────┬───────────────┘
         │
    ┌────┴──────────────┐
    │                   │
    ▼                   ▼
  ОДОБРИТЬ           ОТКЛОНИТЬ
    │                   │
    ▼                   ▼
POST .../approve   Модальное окно
    │              для причины
    │                   │
    │                   ▼
    │            POST .../reject
    │                   │
    ▼                   ▼
  ✅ APPROVED        ❌ REJECTED
    │                   │
    └─────────┬─────────┘
              │
              ▼
  Уведомление бригадиру
  • Telegram сообщение
  • Web UI обновление
  • Email (опционально)
```

---

## Легенда

- **┌─┐** - Процесс/Компонент
- **├─┤** - Вход/Выход
- **├┤** - Данные
- **│** - Поток управления
- **▼** - Следующий этап
- **→** - API вызов
- **(⏳)** - Статус/Иконка
- **[✅]** - Завершено

---

## Notes

1. Все API запросы требуют авторизацию (Bearer token)
2. FSM состояния хранятся в памяти (MemoryStorage)
3. Для production рекомендуется Redis для хранения состояния
4. Все даты хранятся в UTC (PostgreSQL TIMESTAMP)
5. RBAC проверки выполняются на каждом endpoint

