# Система управления доступом к объектам

## Обзор

Реализована полная система управления доступом к строительным объектам, которая позволяет:

1. **Бригадирам** запрашивать доступ к нужным объектам
2. **Менеджерам/Администраторам** одобрять или отклонять запросы доступа
3. **Отслеживать** все запросы и их статусы

## Функционал

### 1. Создание объектов (Object Management)

**Эндпоинт**: `POST /api/v1/objects`

**Доступно**: MANAGER, ADMIN

**Параметры запроса**:
```json
{
  "name": "Строительство жилого комплекса",
  "code": "OBJ-2025-001",  // опционально, генерируется автоматически
  "contract_number": "К-2025-001",
  "material_amount": 1000000.00,
  "labor_amount": 500000.00,
  "contract_amount": 1500000.00  // опционально, рассчитывается автоматически
}
```

**Пример ответа**:
```json
{
  "id": 1,
  "name": "Строительство жилого комплекса",
  "code": "OBJ-2025-001",
  "contract_number": "К-2025-001",
  "contract_amount": 1500000.00,
  "material_amount": 1000000.00,
  "labor_amount": 500000.00,
  "status": "ACTIVE",
  "is_active": true
}
```

### 2. Запрос доступа к объекту

**Эндпоинт**: `POST /api/v1/objects/{object_id}/request-access`

**Доступно**: FOREMAN

**Параметры запроса**:
```json
{
  "reason": "Назначен ответственным за этап кровельных работ"
}
```

**Пример ответа**:
```json
{
  "id": 1,
  "object_name": "Строительство жилого комплекса",
  "status": "PENDING",
  "message": "Запрос на доступ отправлен. Ожидание рассмотрения администратором"
}
```

**Возможные ошибки**:
- `400`: "Вы уже отправили запрос на доступ к этому объекту" (есть активный запрос)
- `400`: "У вас уже есть доступ к этому объекту" (уже одобрено)
- `404`: "Объект не найден"

### 3. Получение моих запросов доступа

**Эндпоинт**: `GET /api/v1/objects/access-requests/my`

**Доступно**: FOREMAN

**Параметры запроса**:
- `status_filter`: Optional - фильтр по статусу (PENDING, APPROVED, REJECTED)

**Пример ответа**:
```json
[
  {
    "id": 1,
    "object_id": 1,
    "object_name": "Строительство жилого комплекса",
    "object_code": "OBJ-2025-001",
    "status": "PENDING",
    "reason": "Назначен ответственным за этап кровельных работ",
    "created_at": "2025-01-26T20:47:16.123456",
    "processed_at": null,
    "rejection_reason": null
  }
]
```

### 4. Просмотр всех запросов доступа к объекту

**Эндпоинт**: `GET /api/v1/objects/{object_id}/access-requests`

**Доступно**: MANAGER, ADMIN

**Параметры запроса**:
- `status_filter`: Optional - фильтр по статусу (PENDING, APPROVED, REJECTED)

**Пример ответа**:
```json
[
  {
    "id": 1,
    "foreman_id": 4,
    "foreman_name": "Иванов И.И.",
    "foreman_phone": "+7 (999) 123-45-67",
    "status": "PENDING",
    "reason": "Назначен ответственным за этап кровельных работ",
    "created_at": "2025-01-26T20:47:16.123456",
    "processed_at": null,
    "processed_by_name": null,
    "rejection_reason": null
  }
]
```

### 5. Одобрение запроса доступа

**Эндпоинт**: `POST /api/v1/objects/{object_id}/access-requests/{request_id}/approve`

**Доступно**: MANAGER, ADMIN

**Параметры запроса**: нет

**Действия при одобрении**:
- Статус запроса меняется с PENDING на APPROVED
- Бригадир автоматически добавляется в список ответственных за объект
- Записывается информация о том, кто и когда одобрил запрос
- Логируется действие в audit log

**Пример ответа**:
```json
{
  "id": 1,
  "status": "APPROVED",
  "foreman_id": 4,
  "object_id": 1,
  "message": "Запрос одобрен. Бригадир foreman получил доступ к объекту"
}
```

**Возможные ошибки**:
- `400`: "Запрос уже обработан (статус: APPROVED)" или "(статус: REJECTED)"
- `404`: "Запрос не найден"
- `404`: "Запрос не относится к этому объекту"

### 6. Отклонение запроса доступа

**Эндпоинт**: `POST /api/v1/objects/{object_id}/access-requests/{request_id}/reject`

**Доступно**: MANAGER, ADMIN

**Параметры запроса**:
```json
{
  "rejection_reason": "Объект уже имеет назначенного бригадира для этих работ"
}
```

**Пример ответа**:
```json
{
  "id": 1,
  "status": "REJECTED",
  "foreman_id": 4,
  "object_id": 1,
  "rejection_reason": "Объект уже имеет назначенного бригадира для этих работ",
  "message": "Запрос отклонён"
}
```

## Статусы запросов доступа

| Статус | Описание |
|--------|---------|
| `PENDING` | Запрос ожидает рассмотрения администратором |
| `APPROVED` | Запрос одобрен, бригадир получил доступ |
| `REJECTED` | Запрос отклонен, указана причина |

## Жизненный цикл запроса доступа

```
[НОВЫЙ ЗАПРОС]
     ↓
[PENDING] - ожидание рассмотрения
    ↙     ↘
[APPROVED]  [REJECTED]
   ↓           ↓
Доступ       Доступ
предоставлен отклонен
```

## Интеграция с системой объектов

### Отношение между CostObject и User

```
CostObject
    ↓
  foremen (многие ко многим)
    ↓
    User
```

После одобрения запроса доступа бригадир автоматически добавляется в список `foremen` объекта.

### Проверка доступа в других операциях

При создании заявок (материалы, техника, табели РТБ) система автоматически проверяет, есть ли у бригадира доступ к объекту:
- Если доступа нет → операция блокируется
- Если доступ есть → операция разрешена

## Примеры использования

### Сценарий 1: Бригадир запрашивает доступ

```
1. Бригадир заходит в свой личный кабинет
2. Видит список объектов без доступа
3. Нажимает "Запросить доступ"
4. Вводит причину (опционально)
5. Отправляет запрос
6. Видит статус "На рассмотрении"
```

### Сценарий 2: Менеджер одобряет запрос

```
1. Менеджер открывает раздел "Управление объектами"
2. Видит объект с количеством ожидающих запросов
3. Нажимает на объект
4. Видит список запросов в статусе PENDING
5. Просматривает информацию о бригадире и причину запроса
6. Нажимает "Одобрить"
7. Бригадир получает доступ
```

### Сценарий 3: Менеджер отклоняет запрос

```
1. Менеджер видит запрос в статусе PENDING
2. Нажимает "Отклонить"
3. Вводит причину отклонения
4. Отправляет
5. Статус запроса меняется на REJECTED
```

## Таблица БД: object_access_requests

| Поле | Тип | Описание |
|------|-----|---------|
| `id` | INTEGER | Первичный ключ |
| `foreman_id` | INTEGER | ID бригадира, запрашивающего доступ (FK users) |
| `cost_object_id` | INTEGER | ID объекта (FK cost_objects) |
| `status` | STRING | Статус запроса (PENDING, APPROVED, REJECTED) |
| `reason` | TEXT | Причина запроса доступа |
| `processed_by_id` | INTEGER | ID менеджера, обработавшего запрос (FK users, nullable) |
| `processed_at` | DATETIME | Время обработки запроса |
| `rejection_reason` | TEXT | Причина отклонения (если статус REJECTED) |
| `created_at` | DATETIME | Время создания запроса |
| `updated_at` | DATETIME | Время последнего обновления |

## Логирование и аудит

Все действия логируются в таблице `audit_log`:
- Создание запроса доступа
- Одобрение запроса (с указанием кто одобрил)
- Отклонение запроса (с указанием причины)

## Безопасность

### Проверки доступа

- Только FOREMAN могут создавать запросы доступа
- Только MANAGER и ADMIN могут одобрять/отклонять запросы
- Бригадир не может запросить доступ дважды к одному объекту
- Бригадир не может запросить доступ, если он уже его имеет

### Валидация

- Обязательна проверка существования объекта
- Проверка что запрос относится к указанному объекту
- Проверка что запрос в правильном статусе для обработки

## API версионирование

Все эндпоинты расположены в `/api/v1/`:
- POST `/api/v1/objects` - создание объекта
- GET `/api/v1/objects` - список объектов
- GET `/api/v1/objects/{id}` - детали объекта
- POST `/api/v1/objects/{object_id}/request-access` - запрос доступа
- GET `/api/v1/objects/{object_id}/access-requests` - список запросов
- GET `/api/v1/objects/access-requests/my` - мои запросы
- POST `/api/v1/objects/{object_id}/access-requests/{request_id}/approve` - одобрение
- POST `/api/v1/objects/{object_id}/access-requests/{request_id}/reject` - отклонение

## Тестирование

### Тестовые пользователи

```
Администратор:
  Логин: admin
  Пароль: admin123
  Роли: ADMIN, MANAGER

Менеджер:
  Логин: manager
  Пароль: manager123
  Роли: MANAGER

Бригадир:
  Логин: foreman
  Пароль: foreman123
  Роли: FOREMAN
```

### Команды для тестирования

#### 1. Получить список объектов
```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:8000/api/v1/objects
```

#### 2. Создать новый объект (как менеджер)
```bash
curl -X POST \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Тестовый объект",
    "contract_number": "К-2025-TEST",
    "material_amount": 100000,
    "labor_amount": 50000
  }' \
  http://localhost:8000/api/v1/objects
```

#### 3. Запросить доступ (как бригадир)
```bash
curl -X POST \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "reason": "Требуется для выполнения работ по электроснабжению"
  }' \
  http://localhost:8000/api/v1/objects/1/request-access
```

#### 4. Получить список запросов (как менеджер)
```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:8000/api/v1/objects/1/access-requests
```

#### 5. Одобрить запрос (как менеджер)
```bash
curl -X POST \
  -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:8000/api/v1/objects/1/access-requests/1/approve
```

#### 6. Отклонить запрос (как менеджер)
```bash
curl -X POST \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "rejection_reason": "На объекте уже работает назначенная бригада"
  }' \
  http://localhost:8000/api/v1/objects/1/access-requests/1/reject
```

## Дальнейшее развитие

1. **Уведомления**: Добавить отправку уведомлений в Telegram при изменении статуса запроса
2. **Интеграция сботом**: Команда `/request-access` для быстрого запроса доступа через Telegram
3. **Frontend компоненты**: Добавить UI для управления запросами в веб-приложении
4. **История изменений**: Расширить audit log с подробной историей всех действий
5. **Автоматическое одобрение**: Настройки для автоматического одобрения для доверенных менеджеров
