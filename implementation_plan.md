# План интеграции РТБ через Telegram Web App

Этот план описывает создание "Хитрого" Web App, который работает на локальном сервере без проброса портов.

## 1. Архитектура решения

**Как это работает без белого IP:**
1.  **Бот (на локальном ПК)** генерирует ссылку на Web App.
    *   В ссылку он "вшивает" список объектов: `.../form.html?objects=Obj1,Obj2`.
2.  **Web App (на GitHub Pages)** открывается у пользователя.
    *   Он строит интерфейс из полученных параметров.
    *   Пользователь вводит данные (выбирает рабочих).
3.  **Отправка:** Web App использует метод `Telegram.WebApp.sendData(JSON)`.
    *   Это отправляет данные **не** на ваш сервер, а в **Telegram Cloud**.
4.  **Бот (на локальном ПК)** получает эти данные от Telegram как обычное сообщение.
    *   Парсит JSON и сохраняет в БД.

## 2. Пошаговая реализация

### Этап 1: База данных (Бэкенд)
Нужно научить систему запоминать "избранных" рабочих для каждого бригадира.

*   **Новая таблица `saved_workers`:**
    *   `id` (PK)
    *   `foreman_id` (FK -> users.id) — Чей это рабочий.
    *   `name` — ФИО (как привык бригадир).
    *   `role` — (опционально) Роль, например "разнорабочий".

### Этап 2: Frontend (Создание формы)
Создаем один файл `timesheet.html` (все в одном для простоты).

*   **Функционал:**
    *   Чтение списка объектов из URL параметров (`?objects=...`).
    *   Поле для ввода имени рабочего + кнопка "Добавить".
    *   Локальное сохранение списка рабочих в `localStorage` браузера (чтобы они сохранялись между открытиями, даже если Интернет плохой, и чтобы не нагружать URL гигантскими списками людей).
    *   Чекбоксы для выбора: "Кто работал сегодня?".
    *   Ползунок часов.
    *   Кнопка `Telegram.WebApp.sendData()`.

### Этап 3: Бот (Бэкенд)
Обновляем файл `backend/app/bot/handlers/time_sheets.py`.

1.  **Изменить команду "Подать табель":**
    *   Вместо вопросов — отправляем кнопку `KeyboardBuilder` с типом `WebApp`.
    *   Генерируем URL: `https://ваш-ник.github.io/timesheet.html?objects=JSON_LIST`.
2.  **Добавить обработчик `web_app_data`:**
    *   Ловит входящие данные от Web App.
    *   Декодирует JSON.
    *   Создает запись в таблице `time_sheets`.

### Этап 4: Развертывание (GitHub Pages)
Инструкция, как сделать этот `timesheet.html` доступным в интернете.

1.  Создать репозиторий на GitHub.
2.  Загрузить туда файл `timesheet.html`.
3.  Включить в настройках "GitHub Pages".
4.  Получить ссылку и прописать её в `.env` бота.

---

## 3. Файлы для изменения

### [MODIFY]
*   `backend/app/models.py` — Добавляем `SavedWorker`.
*   `backend/app/bot/handlers/time_sheets.py` — Логика Web App.
*   `backend/app/bot/keyboards/time_sheets.py` — Кнопка вызова Web App.

### [NEW]
*   `frontend_timetracker/index.html` — Сам файл веб-приложения (мы его создадим отдельно от основного React приложения, чтобы он был максимально легким и быстрым).

## 4. План верификации

1.  Запускаем локально `index.html`, проверяем что форма работает.
2.  Пушим на GitHub.
3.  Запускаем бота, нажимаем кнопку — открывается окно.
4.  Отправляем форму — в консоли бота видим JSON.
5.  Проверяем БД — табель создался.
